---
title: "Where Do You Like A Cup of Safe Coffee?"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source: embed
    code_folding: hide
    theme: flatly
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(leaflet)
library(shiny)
library(httr)
library(rvest)
library(sf)

knitr::opts_chunk$set(
  message = F,
  echo = F,
  warning = F
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 10
)

scale_colour_discrete = scale_colour_viridis_d

scale_fill_discrete = scale_fill_viridis_d

get_location =
  function(location_name = "Columbia University",
           .pd = NA) {
    if (!is.na(.pd)) {
      .pd$tick()$print()
    }
    
    location_name = str_c(
      "https://geosearch.planninglabs.nyc/v1/search?text=",
      location_name,
      ", New York, NY&size=2"
    )
    
    url =
      URLencode(location_name)
    
    df = read_sf(GET(url) %>% content("text"))
    
    if (nrow(df) == 0) {
      return(tibble(
        long = NA,
        lat = NA,
        borough = NA
      ))
    }
    
    geometry = df %>%
      pull(geometry) %>%
      as.tibble() %>%
      mutate(geometry = as.character(geometry),
             geometry = str_replace_all(geometry, "c|[\\(\\)]", "")) %>%
      separate(geometry, into = c("long", "lat"), sep = ",") %>%
      mutate_all(as.numeric) %>%
      summarise(long = mean(long),
                lat = mean(lat))
    return(geometry)
  }
```

```{r data}
if (file.exists("data/map_data.csv")){
  cafe = read_csv(here::here("data/map_data.csv"))
} else {source("map_data.R")}
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r Sidebar}
textInput(
  inputId = "location",
  label = h3("Where You At?"),
  value = "Columbia University"
)

sliderInput(
  inputId = "tolerant",
  label = h3("Risk Willing to take"),
  min =   cafe %>%
    pull(ticket) %>% min(),
  max =  cafe %>%
    pull(ticket) %>% max(),
  value = c(0,2000)
)

checkboxGroupInput(
  "borough",
  label = h2("Which Borough?"),
  choices = cafe %>% distinct(borough) %>% pull(borough),
  selected = cafe %>% distinct(borough) %>% pull(borough) %>% first()
)

```



Row {data-width=1000}
-----------------------------------------------------------------------

### Cafe Map

```{r map}
renderLeaflet({
  plot_cafe_df =
    cafe  %>%
    filter(between(ticket, input$tolerant[1] %>% as.numeric(),
                   input$tolerant[2] %>% as.numeric()),
           borough %in% input$borough)
  
  if (!is.null(input$location)) {
    locat = get_location(input$location)
  } else {locat = get_location()}
  
  pal = colorNumeric(
    palette = c("viridis", "magma", "inferno", "plasma")[[4]],
    domain = plot_cafe_df$ticket %>% sqrt()
  )
  
  plot_cafe_map =
    plot_cafe_df %>%
    mutate(pop =
             str_c("<b>", business_name, "</b><br>",
                   swc_chairs," chairs in ",swc_sq_ft," feet space<br>",
                   round(ticket), " tickets in 500m<br>",
                   adress)) %>%
    select(long,lat,pop,business_name,ticket) %>% 
    leaflet() %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addCircles(
      locat[[1]],
      locat[[2]],
      radius = 1000,
      label = "Your Location",
      weight = 1,
      fillOpacity = 0.5,
      group = "Nearby Cafe"
    ) %>% 
    addCircleMarkers(
      ~ long,
      ~ lat,
      color = ~ pal(ticket %>% sqrt()),
      radius = .1,
      popup = ~ (pop),
      label = ~business_name,
      group = "Cafe Shop"
    ) %>% 
    addLayersControl(
      overlayGroups = c("Nearby Cafe","Cafe Shop"),
      options = layersControlOptions(collapsed = FALSE)
    ) %>% 
    setView(lng = locat[[1]], lat = locat[[2]], zoom = 13)
  
  plot_cafe_map
})
  
```


```{r time,eval=F}
plot_time_df =
  cafe %>% 
  unnest(nearby) %>% 
  mutate(hour = lubridate::hour(issue_date),
         weekday = weekdays(issue_date),
         weekday = 
           forcats::fct_relevel(weekday,c("Monday","Tuesday","Wednesday",
               "Thursday","Friday","Saturday","Sunday"))) %>% 
  drop_na(borough) %>%
  count(weekday, hour, borough, name = "ticket") %>%
  mutate(text = str_c("TIME: ", hour, ":00 on ", weekday, 
                      "<br>Total Tickets:",ticket))
plot_time =
  plot_time_df %>% 
  plot_ly(
    type = "bar",
    x = ~ hour,
    y = ~ ticket,
    text = ~text,
    frame = ~ weekday,
    color = ~ borough,
    colors = viridis::viridis(4,option = "D")
  ) %>%
  layout(barmode = 'group',
         title = "Total Number of Tickets by Hour",
         showlegend = T,
         legend = list(orientation = "h"),
         yaxis =list(type = "log",
                     title = ''),
         xaxis = list(nticks = 24)) %>%
  animation_opts(transition = 0) %>% 
  animation_button(hide =T)
 
plot_time
```

