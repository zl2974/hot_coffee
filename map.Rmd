---
title: "Where Do You Like A Cup of Safe Coffee?"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source: embed
    code_folding: hide
    theme: flatly
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(readxl)
library(patchwork)
library(multcomp)
library(plotly)
library(leaflet)
library(ggplot2)
library(lubridate)
library(shiny)

knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = T,
  echo = F,
  warning = T,
  cache = T
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 10
)

scale_colour_discrete = scale_colour_viridis_d

scale_fill_discrete = scale_fill_viridis_d

```

```{r data, cache=T}
cafe = read_csv(here::here("data/Sidewalk_Caf__Licenses_and_Applications_clean.csv")) %>% 
  left_join(read_csv(here::here("data/zipcode.csv")))

parking = read_csv(here::here("data/parking_vio2021_cleanv1.csv")) %>% 
  select(id,long,lat,issue_date,hour)

get_nearby_area =
  function(p_long = 0, p_lat = 0,area=500) {
    return(
      tibble(
        long_lwr = p_long - area / (6378137 * cos(pi * p_lat / 180)) * 180 / pi,
        long_upr = p_long + area / (6378137 * cos(pi * p_lat / 180)) * 180 /
          pi,
        lat_lwr = p_lat - area / 6378137,
        lat_upr = p_lat + area / 6378137
      )
    )
  }

get_data =
  function(area) {
    data =
      parking %>%
      bind_cols(area) %>%
      filter(long < long_upr,
             long > long_lwr,
             lat < lat_upr,
             lat > lat_lwr) %>% 
      select(id,issue_date)
    
    return(data)
  }


cafe =
  cafe %>%
  mutate(
    nearby = map2(.x = long, .y = lat, ~ get_nearby_area(.x, .y)),
    nearby = map(.x = nearby,  ~ get_data(.x))
  )
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r Sidebar,echo = F}

```



Row {data-width=600}
-----------------------------------------------------------------------

### Cafe Map

```{r map,cache=T}
plot_cafe_df =
  cafe %>%
  mutate(ticket = map_dbl(nearby, nrow))

pal = colorNumeric(palette = c("viridis", "magma", "inferno","plasma")[[4]],
                   domain = plot_cafe_df$ticket %>% sqrt())

plot_cafe_map =
  plot_cafe_df%>%
  mutate(pop =
           str_c("<b>",business_name,"</b><br>",round(ticket)," tickets")) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    ~ long,
    ~ lat,
    color = ~pal(ticket %>% sqrt()),
    radius = .1,
    popup = ~ (pop)
  )

plot_cafe_map
  
```


Row {data-width=400}
-----------------------------------------------------------------------

### Tickets 

```{r time}
plot_time_df =
  cafe %>% 
  unnest(nearby) %>% 
  mutate(hour = lubridate::hour(issue_date),
         weekday = weekdays(issue_date),
         weekday = 
           forcats::fct_relevel(
             weekday,
             c("Monday", "Tuesday", "Wednesday", "Thursday",
               "Friday", "Saturday", "Sunday")
           )) %>% 
  drop_na(borough) %>%
  count(weekday, hour, borough, name = "ticket") %>%
  mutate(text = str_c("TIME: ", hour, ":00 on ", weekday, 
                      "<br>Total Tickets:",ticket)) %>% 
  plot_ly(
    type = "bar",
    x = ~ hour,
    y = ~ ticket,
    text = ~text,
    frame = ~ weekday,
    color = ~ borough,
    colors = viridis::viridis(4,option = "D")
  ) %>%
  layout(barmode = 'group',
         title = "Total Number of Tickets by Hour",
         showlegend = T,
         legend = list(orientation = "h"),
         yaxis =list(type = "log"),
         xaxis = list(nticks = 24)) %>%
  animation_opts(transition = 0) %>% 
  animation_button(hide =T)

plot_time_df
```

