---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(readxl)
library(patchwork)
library(multcomp)
library(plotly)
library(leaflet)
library(ggplot2)
library(lubridate)

knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = T,
  echo = F,
  warning = T,
  cache = T
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 10
)

scale_colour_discrete = scale_colour_viridis_d

scale_fill_discrete = scale_fill_viridis_d

cafe = read_csv(here::here("data/Sidewalk_Caf__Licenses_and_Applications_clean.csv"))

parking = read_csv(here::here("data/parking_vio2021_cleanv1.csv")) %>% 
  select(id,long,lat,issue_date)
```

Row {data-width=600}
-----------------------------------------------------------------------

### Chart A

```{r}
get_nearby_area =
  function(p_long = 0, p_lat = 0,area=500) {
    return(
      tibble(
        long_lwr = p_long - area / (6378137 * cos(pi * p_lat / 180)) * 180 / pi,
        long_upr = p_long + area / (6378137 * cos(pi * p_lat / 180)) * 180 /
          pi,
        lat_lwr = p_lat - area / 6378137,
        lat_upr = p_lat + area / 6378137
      )
    )
  }

get_data =
  function(area) {
    data =
      parking %>%
      bind_cols(area) %>%
      filter(long < long_upr,
             long > long_lwr,
             lat < lat_upr,
             lat > lat_lwr) %>% 
      select(id,issue_date)
    
    return(data)
  }


cafe =
  cafe %>%
  mutate(
    nearby = map2(.x = long, .y = lat, ~ get_nearby_area(.x, .y)),
    nearby = map(.x = nearby,  ~ get_data(.x))
  )
```

```{r map}
plot_cafe_df =
  cafe %>%
  mutate(ticket = map_dbl(nearby, nrow))

pal = colorNumeric(palette = c("viridis", "magma", "inferno","plasma")[[4]],
                   domain = plot_cafe_df$ticket +1%>% log())

plot_cafe_map =
  plot_cafe_df%>%
  mutate(pop =
           str_c("<b>",business_name,"</b><br>",round(ticket)," tickets")) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    ~ long,
    ~ lat,
    color = ~pal(ticket + 1%>% log()),
    radius = .1,
    popup = ~ (pop)
  )

plot_cafe_map
  
```


Row {data-width=400}
-----------------------------------------------------------------------

### Chart B
